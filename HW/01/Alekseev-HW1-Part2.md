Описать максимально подробно, что происходит между нажатием клавиши Enter при вводе в строку адреса браузера URL *http://test.example.com?p1=44&p2=s* и полной подгрузкой всей запрашиваемой страницы (на всех уровнях стека TCP/IP, в операционной системе клиента и сервера, в сетевом оборудовании и т.п.).



Ресурсы:

* Интернет
  * [medium.com](https://medium.com/@maneesha.wijesinghe1/what-happens-when-you-type-an-url-in-the-browser-and-press-enter-bb0aa2449c1a)
  * [stackoverflow.com](https://stackoverflow.com/questions/2092527/what-happens-when-you-type-in-a-url-in-browser)
  * [edusagar.com](http://edusagar.com/articles/view/70/What-happens-when-you-type-a-URL-in-browser)
  * ...
* Kurose, Ross - Computer Networking. A Top-Down Approach (pp. 495–500)



## Стадии

Предполагаем — как в книжке из источников :) — что у нас есть ноутбук, подключённый к кабелю Ethernet, который подключён к Ethernet свичу, который подключён к роутеру, который соединён с ISP (Internet Service Provider), который предоставляет также и DNS услуги.

Считаем, что DHCP сервер находится в роутере.

Опираясь на текст задания (или, вернее, предполагая дополнительно, что к сети мы уже подключились и с этим всё ОК), считаем, что уже был запущен DHCP протокол и у ноутбука уже есть IP адрес, полученный от DHCP сервера.

* Запрос *http://test.example.com?p1=44&p2=s* есть GET запрос, поэтому сначала проверится кэш браузера на наличие такого же запроса.

* Так как в кэше такого нет, то далее браузер проверит кэши на наличие DNS записи, чтобы найти IP адрес, соответствующей *http://test.example.com*

  * Кэш браузера
  * Кэш ОС
  * Кэш роутера
  * Кэш ISP

* Так как в кэше такого URL нет, то надо создать DNS запрос, чтобы выяснить IP адрес сервера *http://test.example.com*. DNS сообщение помещается в UDP сегмент (с портом назначения по DNS серверу), который погружается в IP датаграму (с целевым адресом — адресом DNS сервера, и адресом источника — адресом ноутбука).

  Далее, такое DNS сообщение помещается в Ethernet frame, которая будет отправлена роутеру. Но пока не известен MAC адрес роутера (известен только его IP адрес — из опущенных шагов по подключению ноутбука к сети).

* По ARP протоколу создаётся ARP сообщение (с целевым IP адресом), помещается в Ethernet frame (с широковещательным MAC адресом назначения), которая посылается свичу, который рассылает её дальше всем подключённым устройствам, включая роутер.

* Роутер посылает свичу ответный ARP message в Ethernet frame со своим IP адресом на MAC адрес ноутбука.

* В итоге сообщение доходит до клиента. Извлекается MAC адрес роутера.

* DNS сообщение (с вставленным в него целевым MAC адресом роутера) посылается свичу. А от него — к роутеру.

* От ротера — к ISP, от него — к DNS серверу.

  Далее запрос перейдёт к серверу доменных имён **.com**, который перенаправит запрос к серверу **example.com**, который уже попробует найти IP адрес для **test.example.com** в DNS записях.

  Если бы такой IP адрес найти получилось, то он бы был отправлен браузеру.

  В случае с *http://test.example.com*, насколько я понял, IP адрес установить **не получается**, поэтому на этом этапе всё и закончится, на экране высветится сообщение об ошибке.

  Но на всякий случай приведу ещё ниже краткую информацию о том, что бы могло пойти дальше, если бы IP адрес хоста удалось бы получить.

* DNS сервер создаёт ответное DNS сообщение с IP адресом, соответствующим имени хоста *test.example.com*, помещает в UDP сегмент, в IP датаграму (адресованную ноутбуку), которая через ISP, затем роутер, а после него через Ethernet кабель достигнет цели.

* Клиенту становится известен IP адрес *test.example.com*.

* Браузер пытается установить соединение с сервером *test.example.com*. Как правило, это TCP соединение.

  TCP соединение устанавливается через т.н. процесс three-way handshake: клиент и сервер обмениваются SYN (synchronize) и ACK (acknowledge) сообщениями:

  * Браузер посылает SYN сообщение серверу
  * Если у сервера есть открытые порты, с помощью которых можно установить новое соединение, то он ответит отправкой SYN/ACK пакета
  * Получив пакет SYN/ACK от сервера, клиент в качестве подтверждения отправит серверу ACK пакет

* Браузер отправляет GET HTTP запрос серверу. В отправляемом запросе также содержится информация о самом браузере.

* Сервер обрабатывает запрос.

  Веб сервер отправляет запрос специальной программе — обработчику запросов. Эта программа разбирает запрос; выясняет, что нужно; обновляет информацию на сервере, если надо; создаёт ответ на запрос в некотором формате.

  На этом этапе на стороне сервера также могут происходить подключения к базам данных, выполнению там запросов.

* Сервер отправляет ответ.

  Ответ содержит запрашиваемую клиентом веб страницу, данные о способе кодирования, о том, как закэшировать веб страницу.

* Браузер получает HTTP ответ. Далее может закрыть TCP соединение или использовать его для другого запроса.

* Браузер смотрит код статуса в полученном ответе, он может значить

  * перенаправление
  * запрос на авторизацию
  * ошибку
  * "обычный" ответ

* Если кэшируется, то ответ заносится в кэш.

* Браузер выясняет, что делать дальше с полученным ответом. Что это: HTML страница, картинка, или что-то ещё. Если в HTML странице есть ссылки на картинки, css файлы, javascript файлы, то они доставляются (или нет) браузеру так же, как и основной HTML документ, через дополнительные GET запросы. Эти дополнительные элементы кэшируются.

* Браузер собирает итоговую веб страницу, её вид и содержимое, учитывает css и javascript файлы.

* Браузер отображает собранную HTML страницу (в случае HTML запроса).

Пока разбирался с информацией, чтобы ответить на задание, понял, что, помимо описанного выше, происходит/может происходить ещё много вещей. Например, отображение для пользователя прогресса загрузки, некая проверка соединения с сервером по ходу процесса, обработка куки, работа плагинов и расширений браузера, проверка полученной от сервера информации на вирусы.

Так как запрос по HTTP, а не HTTPS, то некоторые делали (например шифрование) опускаются.